---
title: "Data Cleaning"
output: html_notebook
---

This R Notebook records the exploratory analysis taken to support the data cleaning steps taken in the "Data Cleaning Interface" R Script 

```{r setup, include=FALSE}
proj_dir = rprojroot::find_rstudio_root_file()
knitr::opts_knit$set(root.dir = proj_dir)
```

# 1. Data Cleaning

```{r, include=FALSE}
source("00 source.R")
load("00 envr/Compulsory/ass_copy.R")
load("00 envr/Compulsory/policy_df.R")

```


```{r}
ass_data%>%
  mutate(policylen =ass_data$expirydate - ass_data$effectdate )%>%
  count(policylen)
```

```{r}
any(is.na(ass_data$sprinkler_type))
any(is.na(ass_data$property_cover))
any(is.na(ass_data$LossofIncome_cover))
```

Check that the epy values are accurate

```{r}
pacman::p_load(lubridate)
epy_data = ass_data$epy
epy_calc = days_in_month(ymd(
  paste0(ass_data$ym,"-", ass_data$xm, "-01"))) / 365

epy_diff = epy_calc - epy_data

stopifnot(min(epy_diff) > 0)
ass_data[epy_diff > 0.06,c("effectdate","expirydate","start","ym","xm","epy")]

```

# 2. Cleaned Data Checks

## NA Checks

What percentage of the property cover, has building items being NA?

```{r}
ass_copy%>%
  mutate(building_na = is.na(building_type)| is.na(building_age))%>%
  group_by(building_na)%>%
  summarise(
    count = n(),
    .groups = "keep"
  )
```

# 3. Policy data Checks

For policies with duplicated policyno, situation_num, policy date ranges and accident months, why is this the case?

* LossofIncome_cover was purchased
* riskpostcode was changed

```{r}
policy_df%>%
    group_by(policyno, situation_num, effectdate, expirydate,
             ym, xm)%>%
    filter(n()>1)
```

## Cancellation

```{r}
policy_df%>%
  mutate(diff = expirydate - as.Date(paste0(ym,"-", xm, "-01")))%>%
  group_by(diff)%>%
  tally()%>%
  arrange(desc(diff))
```

