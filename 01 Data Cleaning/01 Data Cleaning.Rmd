---
title: "Data Cleaning"
output: html_notebook
---

This R Notebook records the exploratory analysis taken to support the data cleaning steps taken in the "Data Cleaning Interface" R Script 

```{r setup, include=FALSE}
proj_dir = rprojroot::find_rstudio_root_file()
knitr::opts_knit$set(root.dir = proj_dir)
options(scipen=7)
```

# 1. Data Cleaning

```{r, include=FALSE}
source("00 source.R")
load("00 envr/Compulsory/ass_copy.R")
load("00 envr/Compulsory/policy_df.R")
```


```{r}
ass_data%>%
  mutate(policylen =ass_data$expirydate - ass_data$effectdate )%>%
  count(policylen)
```

```{r}
any(is.na(ass_data$sprinkler_type))
any(is.na(ass_data$property_cover))
any(is.na(ass_data$LossofIncome_cover))
```

Check that the epy values are accurate

```{r}
library(lubridate)
epy_data = ass_data$epy
epy_calc = days_in_month(ymd(
  paste0(ass_data$ym,"-", ass_data$xm, "-01"))) / 365

epy_diff = epy_calc - epy_data

stopifnot(min(epy_diff) > 0)
ass_data[epy_diff > 0.06,c("effectdate","expirydate","start","ym","xm","epy")]

```

# 2. Cleaned Data Checks

## NA Checks

What percentage of the property cover, has building items being NA?

```{r}
ass_copy%>%
  mutate(building_na = is.na(building_type)| is.na(building_age))%>%
  group_by(building_na)%>%
  summarise(
    count = n(),
    .groups = "keep"
  )
```

# All variables - number of missing values and unique values
```{r}
data_check <- ass_copy %>%
  summarise(across(everything(),n_distinct)) %>%
  bind_rows(colSums(is.na(ass_copy)))%>%
  mutate(rowname = c("Unique Values", "Missing Values"))%>%
  pivot_longer(-rowname, names_to = "col")%>%
  pivot_wider(names_from = rowname, values_from = value)
formattable(data_check)
```

# Visualisation of how many NA values for each variable

```{r}
ass_copy %>%
  miss_var_summary() %>%
  mutate(missing = n_miss > 0) %>%
  ggplot(aes(x = stats::reorder(variable, n_miss),
             y = n_miss,
             colour = missing,
             fill = missing)) +
  geom_bar(stat = "identity",
           position = "dodge",
           width = 0) + 
  geom_point() +
  coord_flip() +
  scale_colour_manual(values = c("#8E9796", "#484878")) +
  scale_fill_manual(values = c("#8E9796", "#484878")) +
  labs(y = "# Missing",
       x = "Variables") +
  theme_minimal() +
  theme(legend.position = "none") 


```
# Plot interactions of NA across variables
```{r}
gg_miss_upset(ass_copy, nsets=7, nintersects=NA)
```

# 3. Policy data Checks

For policies with duplicated policyno, situation_num, policy date ranges and accident months, why is this the case?

* LossofIncome_cover was purchased
* riskpostcode was changed

```{r}
policy_df%>%
    group_by(policyno, situation_num, effectdate, expirydate,
             ym, xm)%>%
    filter(n()>1)
```

## Cancellation

```{r}
policy_df%>%
  mutate(diff = as.integer(expirydate - as.Date(paste0(ym,"-", xm, "-01"))))%>%
  group_by(diff)%>%
  tally()%>%
  arrange(desc(diff)) 
```

```{r}
policy_df%>%
  mutate(diff = as.integer(expirydate - as.Date(paste0(ym,"-", xm, "-01"))))%>%
  group_by(diff)%>%
  ggplot(aes(diff)) + 
  geom_bar()
```

